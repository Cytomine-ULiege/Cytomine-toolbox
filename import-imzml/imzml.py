# -*- coding: utf-8 -*-

# * Copyright (c) 2009-2017. Authors: see NOTICE file.
# *
# * Licensed under the Apache License, Version 2.0 (the "License");
# * you may not use this file except in compliance with the License.
# * You may obtain a copy of the License at
# *
# *      http://www.apache.org/licenses/LICENSE-2.0
# *
# * Unless required by applicable law or agreed to in writing, software
# * distributed under the License is distributed on an "AS IS" BASIS,
# * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# * See the License for the specific language governing permissions and
# * limitations under the License.

__author__ = "Rubens Ulysse <urubens@uliege.be>"
__copyright__ = "Copyright 2010-2017 University of Li√®ge, Belgium, http://www.cytomine.be/"

json_data = """{"intervals":[
{"lower":404.8322863891601,"upper":404.9942516967774},
{"lower":406.82056663208004,"upper":406.9833274108887},
{"lower":408.9257973571777,"upper":409.08940039672854},
{"lower":422.843850592041,"upper":423.01302196655274},
{"lower":423.8964659545898,"upper":424.0660584594727},
{"lower":426.8204110778808,"upper":426.99117339477544},
{"lower":430.913952557373,"upper":431.0863526184082},
{"lower":431.96656791992183,"upper":432.13938911132817},
{"lower":432.66833183593747,"upper":432.84143378906253},
{"lower":442.84369503784177,"upper":443.0208679504395},
{"lower":444.0132608825683,"upper":444.19090171508793},
{"lower":445.06590675659174,"upper":445.2439687316895},
{"lower":446.93723651733393,"upper":447.1160471740723},  
{"lower":447.9898518798828,"upper":448.1690836669922},  
{"lower":448.92551676025386,"upper":449.10512288818364},  
{"lower":464.9488007202148,"upper":465.1348174438477},  
{"lower":465.8844656005859,"upper":466.0708566650391},  
{"lower":467.0540314453125,"upper":467.2408904296875},  
{"lower":478.2820405212402,"upper":478.47339160766603},  
{"lower":479.2177054016113,"upper":479.40943082885747},  
{"lower":482.96036492309565,"upper":483.1535877136231},  
{"lower":486.9369254089355,"upper":487.13173914184574},  
{"lower":496.6444561706543,"upper":496.84315369262697},  
{"lower":501.9075940063476,"upper":502.1083972045899},  
{"lower":502.84325888671873,"upper":503.04443642578127},  
{"lower":503.89587424926754,"upper":504.0974729187012},  
{"lower":518.7495618530273,"upper":518.9571031860352},  
{"lower":522.8431033325195,"upper":523.052282409668},  
{"lower":523.8957492065429,"upper":524.1053494262696},  
{"lower":534.1880628906249,"upper":534.4017808593751},  
{"lower":542.8429477783203,"upper":543.0601283935547},  
{"lower":544.9481785034179,"upper":545.1662013793946},  
{"lower":550.5622288085937,"upper":550.7824977539063},  
{"lower":551.4978936889648,"upper":551.7185369750977},  
{"lower":556.994901977539,"upper":557.217744506836},  
{"lower":558.8662317382812,"upper":559.0898229492188},  
{"lower":559.9188776123046,"upper":560.1428899658204},  
{"lower":562.2580093017577,"upper":562.4829574951173},  
{"lower":580.0356420288085,"upper":580.267702697754},  
{"lower":580.9713069091796,"upper":581.2037419189454},  
{"lower":584.9479284179687,"upper":585.1819543945313},  
{"lower":598.8659206298828,"upper":599.1055149169922},  
{"lower":600.9712123779296,"upper":601.2116489501954},  
{"lower":610.0938991943359,"upper":610.3379855712891},  
{"lower":610.4447811523437,"upper":610.6890079101563},  
{"lower":616.0587704345703,"upper":616.3052432373047},  
{"lower":624.9476173095702,"upper":625.1976463623048},  
{"lower":632.9007993041993,"upper":633.1540102661133},  
{"lower":633.9533841552734,"upper":634.2070162353516},  
{"lower":638.8656705444336,"upper":639.121267932129},  
{"lower":656.8772042358398,"upper":657.1400076782227},  
{"lower":676.8770486816406,"upper":677.1478536621095},  
{"lower":678.8653594360351,"upper":679.1369598999024},  
{"lower":694.7716624023437,"upper":695.0496266601563},  
{"lower":715.9411337158202,"upper":716.2275674560548},  
{"lower":716.9937185668946,"upper":717.280573425293},  
{"lower":719.9176942016601,"upper":720.2057188842774},  
{"lower":720.9702790527343,"upper":721.2587248535157},  
{"lower":721.9060049560546,"upper":722.1948251220704},  
{"lower":725.4147024902343,"upper":725.7049264160157},  
{"lower":739.3327557250976,"upper":739.6285479858399},  
{"lower":741.4379864501952,"upper":741.7346209716798},  
{"lower":742.3736513305663,"upper":742.6706601928712},  
{"lower":743.4262972045898,"upper":743.7237272094727},  
{"lower":769.3910128906249,"upper":769.6988308593751},  
{"lower":770.3266777709961,"upper":770.6348700805665},  
{"lower":772.3149885253906,"upper":772.6239763183594},  
{"lower":773.3675733764647,"upper":773.6769822875978},  
{"lower":782.3733402221679,"upper":782.6863521606446},  
{"lower":784.3616509765625,"upper":784.6754583984375},  
{"lower":792.8996158935546,"upper":793.2168391845704},  
{"lower":796.4083744506835,"upper":796.727001525879},  
{"lower":797.3440393310547,"upper":797.6630407470703},  
{"lower":798.3966241821289,"upper":798.7160467163086},  
{"lower":799.3322890625,"upper":799.6520859375},  
{"lower":800.3849349365233,"upper":800.7051529541017},  
{"lower":807.9872349731445,"upper":808.310494519043},  
{"lower":812.4315973876952,"upper":812.7566350341798},  
{"lower":820.3847793823242,"upper":820.7129989379883},  
{"lower":821.3204442626952,"upper":821.6490381591798},  
{"lower":824.361339868164,"upper":824.691150366211},  
{"lower":825.4139857421875,"upper":825.7442173828125},  
{"lower":826.4666316162109,"upper":826.7972843994141},  
{"lower":846.3494950683594,"upper":846.6881025878906},  
{"lower":848.3378058227538,"upper":848.6772088256837},  
{"lower":849.3904516967773,"upper":849.7302758422852},  
{"lower":851.4956824218749,"upper":851.8363488281251},  
{"lower":851.9634843505859,"upper":852.3043379150391},  
{"lower":852.4313473022461,"upper":852.7723880493164},  
{"lower":853.0161302246094,"upper":853.3574049316406},  
{"lower":896.4075966796875,"upper":896.7662314453125},  
{"lower":897.4602425537108,"upper":897.8192984619142},  
{"lower":987.9858960083008,"upper":988.3811694213867},  
{"lower":988.9215608886718,"upper":989.3172086425782},   
{"lower":990.3250887207031,"upper":990.721297998047}]
}"""

home = "/"

if __name__ == '__main__':
    import json
    import cv2
    import numpy as np
    import time
    import os
    from pyimzml.ImzMLParser import getionimage, ImzMLParser

    start_time = time.time()
    p = ImzMLParser(os.path.join(home, 'Rompp-ProteomeXChange2010/HR2MSI mouse urinary bladder S096.imzML'))
    data = json.loads(json_data)
    for i, intervals in enumerate(data['intervals']):
        lower = intervals['lower']
        upper = intervals['upper']
        tol = (upper - lower) / 2
        im = getionimage(p, lower + tol, tol)
        im = np.rint(im)
        im = im.astype(np.uint16)
        cv2.imwrite(
            os.path.join(home, 'ionimages/HR2MSI_mouse_urinary_bladder_S096_{}_{:.2f}.png'.format(i + 1, lower + tol), im))
        print("Image {} | {:.2f} +/- {:.2f}".format(i + 1, lower + tol, tol))
    elapsed_time = time.time() - start_time
    print(elapsed_time)
